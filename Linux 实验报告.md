# Linux 实验报告


## 整体架构
### 服务器
* 服务器在启动后，建立并绑定套接字监听0.0.0.0:port(命令行传入)
* 建立一个新线程，处理服务器管理员输入的命令
* 一旦有用户连接，则验证其发送过来的用户名、密码；如果正确则新建立一个子进程处理交互

### 客户端
* 建立套接字，并设置ip,port(均从命令行解析),进行连接
* 若连接成功,则将user,password(均从命令行解析)发送给服务器进行验证
* 若验证成功,则可开始发送命令给服务器,否则直接关闭客户端

### 用户管理
基于多进程的策略对多用户进行管理
* 一旦用户通过验证，服务器主进程便启动一个新的子进程处理交互
* 由于用户密码通过加密后存储在shadow文件中,所以通过getspnam获取到加密的密码后,与经过加密的、用户输入的密码进行比较
* 通过setuid()、setgid()方法设置进程实际权限，解决文件访问权限问题
* 通过发送信号kill，保证父进程退出时，子进程也退出


## 客户端命令
客户端使用单线程与服务器交互，即不能在传输文件的同时发送命令。
1. put、get
   上传/下载的函数作为双方共有的功能，所以写入shared_function.c中以便复用.
   发送方发送文件前，先计算出文件大小，然后再将文件内容传输.
   接受方则先等待接收文件大小；收到文件大小后，一直接收对方发送的内容，并将其写入文件中，直到收到了整个文件的内容（当前已写入的文件大小 == 之前被对方告知的文件大小）
   !无论发送还是接收，都会先判断有没有权限访问文件，并且通知对方。
   !文件名称在解析命令时就已知道，所以接收方可以创建相应的文件.

2. mput、mget 
   只需要借助strtok函数去解析出多个文件名，然后针对每一个文件调用put\get即可

3. ls
   借助readdir函数不断读当前目录,获取dirent,通过dirent打印文件名

4. dir
   读目录同ls;只不过发送方传输所有文件信息后，传输一个终止符-100,对方接收到后就结束等待接收.

5. mkdir/rmkdir、lmkdir\lrmkdir
   mkdir函数

6. cd/lcd
   chdir函数

7. pwd/lpwd
   

## 服务器管理员命令
维护一个链表，以用户信息（包含用户名、文件描述符等）作为节点，
当用户登录成功后，将用户信息加入链表；
当用户退出后，删除该节点
* count current
  维护一个int型全局变量,在用户登录成功后 +1；退出后-1;使用此命令时printf即可

* count all
  维护一个int型全局变量,编码用户在用户登录成功后，记数加1;使用该命令时printf即可

* kill user
  如果要删除某个用户，则遍历链表，找到该用户的信息，关闭相应的文件描述符，然后删除节点。

* list
  遍历链表，输出用户名

* quit
  遍历链表，关闭所有文件描述符,然后删除链表,退出程序.


